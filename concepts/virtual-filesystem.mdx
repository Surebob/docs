---
title: Virtual Filesystem
description: How isolates provide a node:fs module without a real filesystem
---

## The Challenge

**V8 isolates don't have a real filesystem**, but we need LLMs to:
- Discover available MCP tools
- Read tool documentation
- Import tools naturally

## The Solution: Virtual `node:fs` Module

We create a **custom module** named `node:fs` that contains all file data as JSON:

```javascript
// Virtual node:fs module
const fsData = {
  "/mnt/servers/cosmo-tools/searchEmails.js": "import { __mcpCall } from '../_client.js';\n\nexport async function searchEmails(input) {\n  return __mcpCall('cosmo-tools', 'searchEmails', input);\n}",
  "/mnt/servers/cosmo-tools/getEmail.js": "...",
  // ...all 42 tool files
};

export default {
  readdirSync(path) {
    // Returns directory entries from fsData
  },
  readFileSync(path) {
    return fsData[path];
  },
  existsSync(path) {
    return fsData.hasOwnProperty(path);
  },
  statSync(path) {
    // Returns stat object
  }
};
```

## How LLMs Use It

LLMs can write **completely natural code**:

```javascript
import fs from 'node:fs';

// Just works! No special syntax needed
const servers = fs.readdirSync('/mnt/servers');
console.log('Servers:', servers);
```

## Implementation

### 1. Tool Generation

MCP schemas are converted to JavaScript modules:

```javascript
// Generated from MCP schema
export async function searchEmails(input) {
  return __mcpCall('cosmo-tools', 'searchEmails', input);
}
```

### 2. Module Registration

All tools are registered in the Worker Loader's modules object:

```typescript
modules: {
  'main.js': { js: wrappedUserCode },
  'node:fs': { js: virtualFsModule },  // ← Virtual filesystem
  'mnt/servers/cosmo-tools/searchEmails.js': { js: toolCode },
  'mnt/servers/cosmo-tools/getEmail.js': { js: toolCode },
  // ...all other tools
}
```

### 3. Virtual FS Module

The `createFsModule()` method generates the virtual filesystem:

```typescript
private createFsModule(): string {
  // Build filesystem data from modules
  const fsData: Record<string, string> = {};
  for (const [path, content] of this.modules.entries()) {
    fsData[`/${path}`] = content;
  }
  
  const fsDataJson = JSON.stringify(fsData);
  
  return `
    const fsData = ${fsDataJson};
    
    function listDirectory(dirPath) {
      // Get unique first segments
      const entries = new Set();
      for (const filePath of Object.keys(fsData)) {
        if (filePath.startsWith(cleanPath + '/')) {
          const firstSegment = relativePath.split('/')[0];
          entries.add(firstSegment);
        }
      }
      return Array.from(entries);
    }
    
    export default {
      readdirSync: (path) => listDirectory(path),
      readFileSync: (path) => fsData[path] || '',
      existsSync: (path) => fsData.hasOwnProperty(path),
      statSync: (path) => { /* returns stat object */ }
    };
  `;
}
```

## Supported APIs

The virtual `node:fs` module implements:

<ParamField path="readdirSync" type="function">
  List directory contents
  
  ```javascript
  const files = fs.readdirSync('/mnt/servers/cosmo-tools');
  // → ['searchEmails.js', 'getEmail.js', ...]
  ```
</ParamField>

<ParamField path="readFileSync" type="function">
  Read file contents
  
  ```javascript
  const code = fs.readFileSync('/mnt/servers/cosmo-tools/searchEmails.js', 'utf-8');
  // → Full JavaScript code
  ```
</ParamField>

<ParamField path="existsSync" type="function">
  Check if file/directory exists
  
  ```javascript
  const exists = fs.existsSync('/mnt/servers/cosmo-tools');
  // → true
  ```
</ParamField>

<ParamField path="statSync" type="function">
  Get file/directory stats
  
  ```javascript
  const stats = fs.statSync('/mnt/servers/cosmo-tools');
  console.log(stats.isDirectory()); // → true
  ```
</ParamField>

## Limitations

<Warning>
The virtual filesystem is **read-only** for tool discovery.

LLMs cannot:
- Create new files
- Modify existing files
- Delete files
- Write to `/tmp`

For file operations, use **containers** with real filesystem.
</Warning>

## Performance

<Check>**Advantages:**</Check>
- In-memory data structure (fast lookups)
- No disk I/O
- Instant directory listings
- Embedded at module load time

**Measured Performance:**
- `readdirSync()`: Less than 1ms
- `readFileSync()`: Less than 1ms  
- Total overhead: Negligible

## Testing

The virtual filesystem is tested with **10 comprehensive tests**:

1. Basic filesystem discovery
2. File reading
3. Multiple imports
4. Destructuring imports
5. Error handling (nonexistent paths)
6. Directory detection via `statSync()`
7. Complex data manipulation
8. Async patterns
9. JSON parsing
10. Performance benchmarks

**Result: 10/10 tests pass** ✅

## Comparison to Real Filesystem

| Feature | Virtual FS (Isolate) | Real FS (Container) |
|---------|---------------------|---------------------|
| **Speed** | ~10ms | ~200ms |
| **Read files** | ✅ | ✅ |
| **List directories** | ✅ | ✅ |
| **Write files** | ❌ | ✅ |
| **File stats** | ✅ | ✅ |
| **Tool discovery** | ✅ | ✅ |
| **MCP calls** | ✅ RPC | ⚠️ Not yet |

## Next Steps

<Card title="Tool Discovery" href="/concepts/tool-discovery">
  Learn how LLMs discover and use MCP tools
</Card>

